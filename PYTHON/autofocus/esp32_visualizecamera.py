# -*- coding: utf-8 -*-
"""
Created on Tue Jan 19 10:31:39 2021

@author: diederichbenedict
"""

'''
My X: 12My Y: 11=================
Current frame:
107	109	110	113	115	116	117	119	119	120	120	120	120	119	119	119	118	116	115	114	111	108	105	103	99	95	93	91	85	82	78	74	
114	115	117	118	119	121	123	123	125	125	126	125	126	126	125	125	124	123	121	120	118	115	112	109	106	102	98	94	91	86	83	78	
117	117	119	120	122	124	125	126	127	128	128	128	129	129	128	128	127	127	125	123	122	119	115	112	108	104	101	97	92	87	83	79	
118	119	120	122	124	126	127	128	129	130	131	131	131	132	132	131	131	129	128	127	125	122	119	115	112	108	103	99	94	89	85	80	
121	119	121	124	125	128	128	130	132	132	133	134	134	134	135	134	134	132	130	129	127	124	121	118	114	109	105	101	96	91	85	81	
121	121	123	125	127	130	131	133	134	135	136	136	138	137	138	137	137	136	134	132	130	127	124	121	117	112	107	102	96	92	87	82	
122	121	124	127	129	131	133	135	136	138	138	139	140	140	140	140	140	138	136	134	132	129	125	122	118	114	109	104	99	93	87	83	
121	123	125	127	130	133	135	137	138	140	141	142	142	143	143	142	141	140	139	136	134	131	127	124	120	115	111	106	100	95	90	83	
123	123	126	129	132	136	136	139	141	142	143	143	144	145	145	144	144	142	141	139	136	132	129	125	121	116	112	106	101	95	90	85	
123	124	127	130	133	136	138	140	143	144	145	146	146	146	145	146	145	144	142	140	137	134	130	126	122	117	113	107	101	96	90	85	
123	125	128	131	133	137	139	141	143	145	146	147	148	147	147	147	146	145	143	140	137	135	130	126	122	117	112	107	102	96	91	85	
124	125	128	131	134	137	140	142	144	145	147	148	148	148	148	147	146	145	143	140	138	135	131	127	122	118	113	108	102	95	90	84	
123	125	128	131	133	137	139	142	144	145	147	148	148	148	148	147	146	144	143	141	137	134	130	126	122	117	112	107	100	95	89	84	
123	124	127	129	132	136	139	141	143	145	146	147	148	148	148	147	146	144	142	139	136	133	130	126	121	117	112	106	99	95	88	84	
122	124	126	129	132	134	138	140	143	144	145	147	147	146	146	145	145	143	141	138	135	132	128	124	119	115	110	105	98	93	87	83	
121	122	125	128	130	133	137	139	141	142	144	145	145	145	145	144	142	140	138	136	133	130	126	122	118	113	108	103	97	91	86	81	
120	122	124	127	128	131	134	136	140	141	142	143	143	143	142	142	140	139	137	134	131	128	124	120	116	112	106	101	95	90	84	79	
119	119	122	125	126	130	132	133	136	138	139	139	140	139	139	138	137	136	134	131	128	125	121	116	112	108	103	98	92	88	81	78	
117	118	120	122	124	127	129	132	134	135	136	136	137	137	136	136	134	132	131	128	126	122	118	114	109	104	100	95	90	85	79	76	
114	116	119	120	123	125	127	128	131	131	133	133	134	133	133	132	131	129	127	125	122	119	115	111	106	101	97	92	86	82	78	73	
112	113	116	118	120	122	124	126	127	128	129	129	130	130	129	128	127	126	124	121	118	115	111	108	103	98	93	88	84	79	76	72	
111	112	114	115	117	119	121	122	124	125	126	126	126	125	126	124	123	121	120	117	114	111	107	103	99	94	90	85	81	77	72	69	
108	109	111	113	114	116	117	118	120	121	121	122	122	122	121	121	119	118	116	112	110	107	104	100	95	92	87	83	79	74	70	67	
105	106	108	110	111	113	114	115	116	117	118	118	118	118	117	116	115	113	111	109	107	103	99	96	92	88	83	79	77	71	68	65	
---------------
'''
"""
Created on Sat Dec  5 14:59:11 2020

@author: bene
"""
import serial
import time
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit
from scipy.ndimage import gaussian_filter


# Define model function to be used to fit to the data above:
def gauss(x, *p):
    A, mu, sigma = p
    return A*np.exp(-(x-mu)**2/(2.*sigma**2))

def setpos(x,y=None,z=None):
    if type(x)==tuple or type(x)==np.ndarray:
        x,y,z=x[0],x[1],x[2]
    
    return {'x': x, 'y': y, 'z': z}

def getpos(pos):
    return np.array(((pos['x']),(pos['y']),(pos['z'])))




# Initiliaze Focussensor
myserialport = "COM23"#/dev/cu.SLAB_USBtoUART" #"COM22" #"/dev/ttyUSB1"
ser = serial.Serial(myserialport, 115200)#, bytesize=8, stopbits=serial.STOPBITS_ONE, parity=serial.PARITY_NONE)
time.sleep(2)
ser.flushInput()

# Read the focus value
# returns relative focus pos - if .65 is in focus you should somehow fix this value by moving focus up and down

focus_val = -1
imagelist = []
decoded_bytes = ""
iiter = 0
while(True):
    ser_bytes = ser.readline()
    decoded_bytes = (ser_bytes[0:len(ser_bytes)-2].decode("utf-8"))
    decoded_value = decoded_bytes.split(",")
    
    print(decoded_bytes)
    if decoded_bytes == ('---------------'):
        try:
            aa = np.int16(np.array((imagelist[1:])))
            plt.title("Laserspot after Red Filter, Mattscheibe, 8mm distance"), plt.imshow(aa, cmap='gray'), plt.colorbar()
            #plt.savefig(str(iiter)+"_focussensor.png"), 
            plt.show()
            iiter +=1
        except Exception as e:
            print("Somethnig went wrong: "+str(e))
        imagelist=[]
        ser.flushInput()
        time.sleep(.5)

    else:
        imagelist.append(decoded_value[0:-1])



ser.close()
       